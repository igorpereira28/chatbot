# app.py
import psycopg2
import faiss
import numpy as np
from sentence_transformers import SentenceTransformer

# Conex√£o PostgreSQL
conn = psycopg2.connect(
    host="localhost",
    database="postgres",
    user="postgres",
    password="senha123"
)
cursor = conn.cursor()

# Criar tabela (se n√£o existir)
cursor.execute("""
CREATE TABLE IF NOT EXISTS textos (
    id SERIAL PRIMARY KEY,
    texto TEXT NOT NULL
)
""")
conn.commit()

# Textos para inserir
documentos = [
    "Receita de bolo de chocolate fofinho: bata ovos, a√ß√∫car e manteiga at√© formar um creme. Adicione farinha de trigo, chocolate em p√≥ e fermento. Asse em forno m√©dio e cubra com brigadeiro feito de leite condensado, chocolate e manteiga.",
    "Panqueca americana: misture farinha, leite, ovos e fermento at√© formar uma massa cremosa. Frite em frigideira antiaderente e sirva com maple syrup e frutas vermelhas.",
    "Arroz de forno com frango: refogue frango desfiado com cebola e alho, misture com arroz cozido, milho, ervilha e molho de tomate. Cubra com queijo e leve ao forno para gratinar.",
    "Salada Caesar: rasgue folhas de alface romana, adicione croutons, queijo parmes√£o e molho Caesar √† base de anchova, alho, lim√£o e mostarda.",
    "Lasanha de berinjela: grelhe fatias de berinjela, intercale com molho de tomate, queijo e leve ao forno at√© gratinar.",
    "Sopa de legumes caseira: cozinhe cenoura, batata, abobrinha e chuchu em caldo temperado com alho, cebola e salsinha. Bata parte da sopa no liquidificador para dar cremosidade.",
    "Risoto de cogumelos: refogue arroz arb√≥reo com cebola, adicione vinho branco e v√° acrescentando caldo aos poucos. Adicione cogumelos refogados e finalize com manteiga e parmes√£o.",
    "Frango ao curry: frite peda√ßos de frango, adicione curry em p√≥, leite de coco e deixe cozinhar at√© engrossar. Sirva com arroz basmati.",
    "Torta de ma√ß√£: forre uma forma com massa folhada, recheie com ma√ß√£s fatiadas, a√ß√∫car e canela. Cubra com mais massa e leve ao forno at√© dourar.",
    "Espaguete ao alho e √≥leo: cozinhe o macarr√£o, frite alho fatiado em azeite e adicione o macarr√£o escorrido. Finalize com pimenta vermelha e salsinha.",
    "Quiche de alho-por√≥: prepare uma massa podre, recheie com alho-por√≥ refogado e uma mistura de creme de leite, ovos e queijo. Asse at√© firmar.",
    "Hamb√∫rguer artesanal: molde carne mo√≠da temperada, grelhe e sirva no p√£o com queijo cheddar, bacon crocante, alface e tomate.",
    "Mousse de maracuj√°: bata no liquidificador leite condensado, creme de leite e suco concentrado de maracuj√°. Leve √† geladeira at√© firmar.",
    "P√£o de queijo mineiro: misture polvilho azedo, leite quente, ovos e queijo meia cura ralado. Modele e asse at√© dourar.",
    "Crepioca: misture ovo com goma de tapioca e queijo, tempere com sal e ervas finas. Cozinhe na frigideira dos dois lados.",
    "Bife acebolado: tempere bifes com sal e alho, frite e reserve. Na mesma panela, refogue cebolas em rodelas. Sirva com arroz e feij√£o tropeiro.",
    "Bolinho de chuva: misture ovos, a√ß√∫car, leite e farinha. Frite colheradas da massa em √≥leo quente e passe no a√ß√∫car com canela.",
    "Caldo verde: cozinhe batatas, bata no liquidificador, volte √† panela com couve fatiada e lingui√ßa calabresa. Deixe ferver e sirva quente.",
    "Chili con carne: refogue carne mo√≠da, adicione feij√£o cozido, tomate, piment√£o e especiarias como cominho e p√°prica. Cozinhe at√© engrossar.",
    "Brigadeiro tradicional: cozinhe leite condensado, chocolate em p√≥ e manteiga at√© desgrudar da panela. Enrole e passe no granulado."
]

# Limpar tabela (opcional)
cursor.execute("DELETE FROM textos")
conn.commit()

# Inserir textos
for doc in documentos:
    cursor.execute("INSERT INTO textos (texto) VALUES (%s)", (doc,))
conn.commit()

# Buscar IDs e textos para gerar embeddings
cursor.execute("SELECT id, texto FROM textos ORDER BY id")
rows = cursor.fetchall()

# Modelo de embeddings
model = SentenceTransformer("all-MiniLM-L6-v2")

texts = [row[1] for row in rows]
ids = [row[0] for row in rows]

# Gera embeddings normalizados
embeddings = model.encode(texts, normalize_embeddings=True).astype("float32")

# Cria √≠ndice FAISS
index = faiss.IndexFlatIP(embeddings.shape[1])
index.add(embeddings)

# Salva √≠ndice no disco
faiss.write_index(index, "faiss.index")

print("üì¶ Banco PostgreSQL e √≠ndice FAISS criados com sucesso!")

# Fecha conex√£o (pode deixar aberta se quiser continuar)
cursor.close()
conn.close()
